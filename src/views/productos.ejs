<%- include('./templates/header'); -%>
<!-- 
                Autor Jesus pineda / "Otro autor"
                13/08/2020
                Proposito de esta pagina: Esta es la pagina de productos 
                aqui se gestionanran los diferente produstos 
              -->
<!-- Aqui Agregar el contenido para las paginas del sistemas  -->

<div class="modal fade" id="addProduct" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="exampleModalLongTitle">Agregar un nuevo producto</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formProducto" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="producto">Nombre del producto:</label>
                        <input type="text" class="form-control " name="producto" id="producto"
                            placeholder="Nombre del producto" required>
                    </div>
                    <div class="form-group">
                        <label for="precio">Precio del producto</label>
                        <input type="number" class="form-control " name="precio" id="precio" placeholder="Precio"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="categoria">Asignar categoria:</label>
                        <select id="categoria" class="custom-select" name="categoriaId" required>

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="desc">Descripcion (opcional)</label>
                        <textarea id="desc" name="desc" class="form-control" rows="2" required></textarea>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <input id="seveProduct" type="submit" class="btn btn-primary" value="Guardar">
            </div>
            <!-- Fin del formulario -->
            </form>
        </div>
    </div>
</div>
<!-- CARDS -->
<div class="main-container-list">
    <div class="text-white row justify-content-center">
        <div style="margin: auto;">
            <button style="margin: 10px;" class="btn btn-lg btn-secondary ">Filtrar <i
                    class="fas fa-filter"></i></button>
            <button style="margin: 10px;" class="btn btn-lg btn-warning"><i class="fas fa-plus"></i> Agregar
                Categoria</button>
            <button id="btn-newProduct" style="margin: 10px;" class="btn btn-lg btn-warning"><i class="fas fa-plus"></i>
                Agregar
                productos</button>
        </div>
    </div>
    <!-- categorias -->
    <div id="container-list" class="row text-center justify-content-center">

    </div>
    <hr>
    <!-- productos -->
    <div class="container">
        <div id="container-productos" class="text-white row text-center justify-content-center">

        </div>
    </div>

</div>
<%- include('./templates/scripts.ejs'); -%>

<script>

    //Funcion inicial se ejecuta al llamar la rutas productos  y hace 
    //la insercion de las categorias 
    (async () => {
        const content = document.getElementById('container-list');

        let response = await getCategories();

        response.map((category) => {
            // <img height="100%" width="100%" src="${category.imagen}"></img>
            const categoria = `
            <div onclick="getProductsByCategory(${category.categoriaId})" class="text-warning col-sm-2 card-category border border-warning">
                <p class="text-category" >${category.categoria.toUpperCase()}</p>
                
            </div>`;
            content.insertAdjacentHTML('beforeEnd', categoria);
        })
    })();

    //Funcion para obtener las categorias  
    async function getCategories() {
        try {
            const response = await fetch(links.urlCategory, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'token': sessionStorage.getItem("token"),
                }

            });
            return response.json();
        } catch (error) {

        }
    }
    //Funcion borrar un producto
    async function DeleteProduct(producId, categoriaId) {
        var result = window.confirm("Â¿Desea borrar este producto?");
        if (result == true) {
            const response = await fetch(links.products + `${producId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'token': sessionStorage.getItem("token"),
                }

            });
            getProductsByCategory(categoriaId)
            return response.json();
        }else{
            window="null"
        }

    }
    //Funcion para obtener productos por categoria
    async function getProductsByCategory(id) {
        const content = document.getElementById('container-productos');

        const response = await fetch(links.products + `${id}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'token': sessionStorage.getItem("token"),
            }
        });
        const result = await response.json();

        if (result.length > 0) {
            content.innerHTML = " ";
            result.map((productos) => {
                const products = `
                <div id="productCard"  class="card product text-dark animate__animated animate__bounce" style="width: 11rem;">
                    <img class="card-img-top" height="125px" src="../../image/pastel.jpg" alt="Card image cap">
                    <div class="card-body">
                        <p class="card-text"><strong>${productos.producto.toUpperCase()}</strong></p>
                        <p class="card-text"><strong>$${productos.precio}</strong></p>
                    </div>
                    <button class="btn-danger form-control" onclick="DeleteProduct(${productos.productoId},${id})">BORRAR</button>
                </div>               
                    `;
                content.insertAdjacentHTML('beforeEnd', products);
            })
        } else {
            content.innerHTML = "SIN PRODUCTOS"
        }
    }
    let btn = document.getElementById("btn-newProduct")
    btn.addEventListener('click', async () => {
        const content = document.getElementById("categoria");

        let categories = await getCategories();
        content.innerHTML = "<option value='NULL' disabled selected >CATEGORIAS</option>";
        if (categories.length > 0) {

            categories.map((categorias) => {
                const products = `<option value="${categorias.categoriaId}">${categorias.categoria}</option> `;
                content.insertAdjacentHTML('beforeEnd', products);
            })
            $("#addProduct").modal("show");

        } else {
            content.innerHTML = "SIN PRODUCTOS"
        }

    }, false);
    let formElement = document.querySelector("#formProducto");

    formElement.addEventListener("submit", async (event) => {
        event.preventDefault();

        const data = new FormData(event.currentTarget);

        const response = await fetch(links.products, {
            method: 'POST',
            headers: {
                'token': sessionStorage.getItem("token"),
            },
            body: new URLSearchParams({
                'producto': data.get('producto'),
                'precio': data.get('precio'),
                'categoriaId': data.get('categoriaId'),
                'desc': data.get('desc'),
                
            })
        });

        let result = await response.json();

        if (result.error) {
            console.log(result)
        } else {
            getProductsByCategory(data.get('categoriaId'));
            document.querySelector("#formProducto").reset();
            $("#addProduct").modal("hide");
            
        }
    });
</script>
</body>

</html>